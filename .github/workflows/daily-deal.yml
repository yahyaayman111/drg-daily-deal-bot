name: DRG Daily Deal

# Run manually + every day at 00:05 UTC
on:
  workflow_dispatch:
  schedule:
    - cron: '5 0 * * *'

jobs:
  post-deal:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch Todayâ€™s Deal JSON
        id: fetch
        run: |
          # Get today's date in UTC (YYYY-MM-DD)
          DATE=$(date -u +'%Y-%m-%d')
          URL="https://doublexp.net/static/json/bulkmissions/${DATE}.json"
          # Download the JSON content
          RESPONSE=$(curl -s $URL)
          # Store it in an environment variable
          echo "RESPONSE=$RESPONSE" >> $GITHUB_ENV

      - name: Parse Deal Fields
        id: parse
        run: |
          # Extract fields using jq and save them to text files
          jq -r '.dailyDeal.DealType'     <<<"$RESPONSE" > deal_type.txt
          jq -r '.dailyDeal.ResourceAmount'<<<"$RESPONSE" > deal_amt.txt
          jq -r '.dailyDeal.Resource'     <<<"$RESPONSE" > deal_res.txt
          jq -r '.dailyDeal.Credits'      <<<"$RESPONSE" > deal_price.txt
          jq -r '.dailyDeal.ChangePercent'<<<"$RESPONSE" > deal_chg.txt

      - name: Post to Discord via curl
        run: |
          # Read values from the text files
          read -r TYPE   < deal_type.txt
          read -r AMT    < deal_amt.txt
          read -r RES    < deal_res.txt
          read -r PRICE  < deal_price.txt
          read -r CHANGE < deal_chg.txt

          # Build the message content
          CONTENT="**ðŸŽ‰ Deep Rock Galactic Daily Deal**\n\
â€¢ **Type:** $TYPE\n\
â€¢ **Offer:** $AMTÂ Ã—Â $RES\n\
â€¢ **Price:** $PRICE credits\n\
â€¢ **Change:** $CHANGE%"

          # Send the message to your Discord webhook
          curl -H "Content-Type: application/json" \
               -d "{\"content\": \"$CONTENT\"}" \
               https://discordapp.com/api/webhooks/1362638254439927859/MfZ5Nd8bs_KDLd2LZlGmzSfUVsBSSE1vkZEVF9K-5NQfIgk6ujUUO1SwZVi2AoFC-htP
